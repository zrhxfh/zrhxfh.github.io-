<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>3D Web FPS Demo</title>
  <style>html,body{overflow:hidden;width:100%;height:100%;margin:0;}#renderCanvas{width:100%;height:100%;touch-action:none;}</style>
  <script src="https://cdn.babylonjs.com/babylon.js"></script>
  <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
</head>
<body>
  <canvas id="renderCanvas"></canvas>
  <script>
    const canvas = document.getElementById("renderCanvas");
    const engine = new BABYLON.Engine(canvas, true);

    const createScene = () => {
      const scene = new BABYLON.Scene(engine);
      scene.clearColor = new BABYLON.Color3(0.5, 0.8, 0.9);

      // 相机（第一人称）
      const camera = new BABYLON.UniversalCamera("cam", new BABYLON.Vector3(0, 2, -10), scene);
      camera.setTarget(BABYLON.Vector3.Zero());
      camera.attachControl(canvas, true);
      camera.speed = 0.5;
      camera.angularSensibility = 4000;

      // 光源
      new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);

      // 地面
      const ground = BABYLON.MeshBuilder.CreateGround("grd", { width: 100, height: 100 }, scene);
      const groundMat = new BABYLON.StandardMaterial("grdMat", scene);
      groundMat.diffuseColor = new BABYLON.Color3(0.3, 0.5, 0.2);
      ground.material = groundMat;

      // 敌人（随机小球）
      const enemyMat = new BABYLON.StandardMaterial("em", scene);
      enemyMat.diffuseColor = new BABYLON.Color3(1, 0, 0);
      const enemies = [];
      for (let i = 0; i < 10; i++) {
        const e = BABYLON.MeshBuilder.CreateSphere(`e${i}`, { diameter: 1 }, scene);
        e.material = enemyMat;
        e.position = new BABYLON.Vector3(
          Math.random() * 40 - 20,
          0.5,
          Math.random() * 40 - 20
        );
        enemies.push(e);
      }

      // 子弹池
      const bullets = [];
      const bulletMat = new BABYLON.StandardMaterial("bm", scene);
      bulletMat.diffuseColor = new BABYLON.Color3(1, 1, 0);
      scene.onPointerObservable.add((pointerInfo) => {
        if (pointerInfo.type === BABYLON.PointerEventTypes.POINTERDOWN) {
          const bullet = BABYLON.MeshBuilder.CreateSphere("bullet", { diameter: 0.2 }, scene);
          bullet.material = bulletMat;
          bullet.position = camera.position.clone();
          const dir = camera.getTarget().subtract(camera.position).normalize();
          bullet.metadata = dir.scale(1.5); // 速度向量
          bullets.push(bullet);
        }
      });

      // 每帧逻辑
      scene.registerBeforeRender(() => {
        bullets.forEach((b, idx) => {
          b.position.addInPlace(b.metadata);
          // 命中检测
          enemies.forEach((e) => {
            if (b.intersectsMesh(e, false)) {
              e.dispose();
              b.dispose();
              bullets.splice(idx, 1);
            }
          });
          // 清理飞出场景
          if (b.position.length() > 100) {
            b.dispose();
            bullets.splice(idx, 1);
          }
        });
      });

      return scene;
    };

    const scene = createScene();
    engine.runRenderLoop(() => scene.render());
    window.addEventListener("resize", () => engine.resize());
  </script>
</body>
</html>
